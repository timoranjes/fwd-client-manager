{% extends "base.html" %}

{% block header_title %}Calendar{% endblock %}

{% block content %}
<div class="data-card">
    <div class="data-card-body">
        <div id="calendar"></div>
    </div>
</div>

<style>
.calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 20px; }
.calendar-header { 
    background: #f9fafb; 
    padding: 12px; 
    text-align: center; 
    font-weight: 600; 
    color: #6b7280; 
    font-size: 0.8rem;
}
.calendar-day {
    min-height: 80px;
    padding: 10px;
    background: white;
    border: 1px solid #f0f0f0;
    border-radius: 8px;
}
.calendar-day.other { background: #f9fafb; color: #9ca3af; }
.calendar-day.today { background: #dbeafe; border-color: #0066cc; }
.day-number { font-weight: 600; margin-bottom: 8px; color: #1a1a2e; }
.event { 
    font-size: 0.7rem; 
    padding: 3px 8px; 
    border-radius: 4px; 
    margin-top: 4px;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.event.safe { background: #dcfce7; color: #16a34a; }
.event.warning { background: #fef3c7; color: #d97706; }
.event.danger { background: #fee2e2; color: #dc2626; }
</style>

<script>
let currentDate = new Date();
let events = [];

async function loadEvents() {
    try {
        const response = await fetch('/api/calendar_events');
        events = await response.json();
        renderCalendar();
    } catch (error) {
        console.error('Error loading events:', error);
        renderCalendar();
    }
}

function renderCalendar() {
    const calendar = document.getElementById('calendar');
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const today = new Date();
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button onclick="changeMonth(-1)" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <h4 class="m-0" style="font-weight: 600; color: #1a1a2e;">${monthNames[month]} ${year}</h4>
            <button onclick="changeMonth(1)" class="btn btn-outline-secondary btn-sm">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="calendar">
            <div class="calendar-header">Sun</div>
            <div class="calendar-header">Mon</div>
            <div class="calendar-header">Tue</div>
            <div class="calendar-header">Wed</div>
            <div class="calendar-header">Thu</div>
            <div class="calendar-header">Fri</div>
            <div class="calendar-header">Sat</div>
    `;
    
    for (let i = 0; i < firstDay.getDay(); i++) {
        html += `<div class="calendar-day other"></div>`;
    }
    
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
        const dayEvents = events.filter(e => e.date === dateStr);
        
        let eventHtml = '';
        dayEvents.forEach(event => {
            let eventClass = 'safe';
            const eventDate = new Date(event.date);
            const daysDiff = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
            if (daysDiff <= 0) eventClass = 'danger';
            else if (daysDiff <= 30) eventClass = 'warning';
            
            eventHtml += `<div class="event ${eventClass}" onclick="window.location.href='/client/${event.id}'">${event.name}</div>`;
        });
        
        html += `
            <div class="calendar-day ${isToday ? 'today' : ''}">
                <div class="day-number">${day}</div>
                ${eventHtml}
            </div>
        `;
    }
    
    html += '</div>';
    calendar.innerHTML = html;
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
}

loadEvents();
</script>
{% endblock %}
